# ScanMalware.vue
<template>
  <div class="space-y-6">
    <!-- Header -->
    <div class="rounded-xl border bg-white dark:bg-[#0f1424] p-5">
      <h2 class="text-xl font-semibold">
        <span class="inline-flex items-center gap-2 px-2 py-1 rounded-lg border bg-rose-50/60 text-rose-900">
          üõ°Ô∏è <span>Malware-Scan ¬∑ Ticket #{{ tid }}</span>
        </span>
      </h2>
    </div>

    <!-- Lade-/Fehlerzustand -->
    <div v-if="error" class="p-3 rounded bg-red-50 text-red-700 text-sm">{{ error }}</div>
    <div v-else-if="!ticket" class="text-sm opacity-70">L√§dt‚Ä¶</div>

    <div v-else class="space-y-6">
      <!-- 3 Cards -->
      <div class="grid lg:grid-cols-3 gap-6">
        <!-- Kunde -->
        <div class="rounded-xl border bg-white dark:bg-[#0f1424] p-4">
          <div class="font-semibold mb-3 flex items-center gap-2">üë§ Kunde</div>
          <div class="grid grid-cols-1 gap-3 text-sm">
            <div><div class="opacity-60">Name</div><div class="font-medium break-all">{{ ticket.name || '‚Äî' }}</div></div>
            <div><div class="opacity-60">E-Mail</div><div class="font-medium break-all">{{ ticket.email || '‚Äî' }}</div></div>
            <div>
              <div class="opacity-60">Beschreibung</div>
              <div class="font-medium break-words whitespace-pre-wrap min-h-[3rem] bg-black/5 dark:bg-white/10 rounded p-2">
                {{ ticket.beschreibung || '‚Äî' }}
              </div>
            </div>
          </div>
        </div>

        <!-- SFTP -->
        <div class="rounded-xl border bg-white dark:bg-[#0f1424] p-4">
          <div class="font-semibold mb-3 flex items-center gap-2">üîê SFTP Zugang</div>
          <div class="grid grid-cols-1 gap-3 text-sm">
            <div><div class="opacity-60">Host</div><div class="font-medium break-all">{{ ticket.access?.ftp_host || '‚Äî' }}</div></div>
            <div><div class="opacity-60">User</div><div class="font-medium break-all">{{ ticket.access?.ftp_user || '‚Äî' }}</div></div>
            <div><div class="opacity-60">Passwort</div><div class="font-medium">{{ ticket.access?.ftp_pass ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '‚Äî' }}</div></div>
            <div><div class="opacity-60">Aktueller Root-Pfad</div><div class="font-medium break-all">{{ rootPath }}</div></div>
          </div>
        </div>

        <!-- Website/Hosting -->
        <div class="rounded-xl border bg-white dark:bg-[#0f1424] p-4">
          <div class="font-semibold mb-3 flex items-center gap-2">üåê Website & Hosting</div>
          <div class="grid grid-cols-1 gap-3 text-sm">
            <div>
              <div class="opacity-60">Domain</div>
              <div class="font-medium break-all">
                <a v-if="ticket.domain" :href="ticket.domain" target="_blank" class="underline">{{ ticket.domain }}</a>
                <span v-else>‚Äî</span>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div><div class="opacity-60">CMS</div><div class="font-medium break-all">{{ ticket.cms || '‚Äî' }}</div></div>
              <div><div class="opacity-60">Hoster</div><div class="font-medium break-all">{{ ticket.hoster || '‚Äî' }}</div></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div><div class="opacity-60">Website User</div><div class="font-medium break-all">{{ ticket.access?.website_user || '‚Äî' }}</div></div>
              <div><div class="opacity-60">Website Passwort</div><div class="font-medium">{{ ticket.access?.website_pass ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '‚Äî' }}</div></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div><div class="opacity-60">Prio</div><div class="font-medium break-all">{{ ticket.prio || '‚Äî' }}</div></div>
              <div><div class="opacity-60">Status</div><div class="font-medium break-all">{{ ticket.status || '‚Äî' }}</div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Findings farbig -->
      <!-- Totals -->
      <div class="grid md:grid-cols-4 gap-4"><!-- von 3 auf 4 -->
        <div class="rounded-lg border p-4 bg-blue-50/40 dark:bg-blue-900/10">
          <div class="flex items-center gap-2 text-sm"><span>üì¶</span><span>Total</span></div>
          <div class="text-2xl font-semibold mt-1">{{ activeScan?.summary?.counts?.total ?? 0 }}</div>
        </div>

        <div class="rounded-lg border p-4 bg-green-50/40 dark:bg-green-900/10">
          <div class="flex items-center gap-2 text-sm"><span>‚úì</span><span>Clean</span></div>
          <div class="text-2xl font-semibold mt-1">{{ activeScan?.summary?.counts?.clean ?? 0 }}</div>
        </div>
        <div class="rounded-lg border p-4 bg-yellow-50/40 dark:bg-yellow-900/10">
          <div class="flex items-center gap-2 text-sm"><span>‚ö†Ô∏è</span><span>Suspicious</span></div>
          <div class="text-2xl font-semibold mt-1">{{ activeScan?.summary?.counts?.suspicious ?? 0 }}</div>
        </div>
        <div class="rounded-lg border p-4 bg-rose-50/40 dark:bg-rose-900/10">
          <div class="flex items-center gap-2 text-sm"><span>‚úñ</span><span>Malicious</span></div>
          <div class="text-2xl font-semibold mt-1">{{ activeScan?.summary?.counts?.malicious ?? 0 }}</div>
        </div>
      </div>
    </div>


    <!-- Inline SFTP Explorer -->
    <SftpExplorerInline
      class="mt-2"
      :ticket-id="tid"
      :initial-path="rootPath"
      v-model:path="rootPath"
      :host="ticket?.access?.ftp_host"
      :username="ticket?.access?.ftp_user"
      :password="ticket?.access?.ftp_pass"
      :sid="sftpSid"
      :auto-connect="false"
      @connected="onSftpConnected"
    />

    <!-- Scan starten + Status -->
<div class="grid lg:grid-cols-2 gap-6">
  <!-- Start -->
  <div class="rounded-xl border bg-white dark:bg-[#0f1424] p-4">
    <div class="flex items-center gap-2 mb-3">
      <span>üöÄ</span><h3 class="font-semibold">Scan starten</h3>
    </div>
    <div class="text-sm grid gap-3">
      <div>
        <div class="opacity-60 mb-1">Root-Pfad</div>
        <input class="w-full rounded border px-3 py-2 bg-transparent" v-model="startForm.root_path" />
      </div>
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" v-model="startForm.quick" />
        <span>Quick-Scan</span>
      </label>
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" v-model="startForm.overwrite_baseline" />
        <span>Baseline neu schreiben</span>
      </label>
      <div class="flex gap-2">
        <button
          class="px-4 py-2 rounded bg-green-600 text-white disabled:opacity-50"
          :disabled="starting || (!sftpSid && !(ticket?.access?.ftp_host && ticket?.access?.ftp_user && ticket?.access?.ftp_pass))"
          @click="onStart">Start</button>
      </div>
    </div>
  </div>

  <!-- Status -->
  <div class="rounded-xl border bg-white dark:bg-[#0f1424] p-4">
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-2">
        <span>üß™</span><h3 class="font-semibold">Status</h3>
      </div>
      <div class="flex items-center gap-2">
        <button
          v-if="activeScan && ['running','queued'].includes(activeScan.status)"
          class="px-3 py-1 rounded bg-rose-600 text-white disabled:opacity-50"
          :disabled="canceling"
          @click="onCancel">
          Abbrechen
        </button>
        <div v-if="activeScan" class="text-xs opacity-70">Scan #{{ activeScan.id }}</div>
      </div>
    </div>

    <div class="text-sm" v-if="activeScan">
      <div class="flex items-center justify-between">
        <div>{{ activeScan.status }}</div>
        <div class="font-mono">{{ activeScan.progress ?? 0 }}%</div>
      </div>
      <div class="h-2 bg-black/5 dark:bg-white/10 rounded mt-2">
        <div class="h-2 bg-green-600 rounded" :style="{ width: (activeScan.progress || 0) + '%' }"></div>
      </div>
    </div>
    <div v-else class="text-sm opacity-70">Kein aktiver Scan.</div>
  </div>
</div>


    <!-- Tabs -->
    <div class="rounded-xl border bg-white dark:bg-[#0f1424] p-0">
      <nav class="flex flex-wrap gap-2 p-2 border-b">
        <button v-for="t in tabs" :key="t.key" @click="activeTab = t.key"
          class="px-3 py-2 rounded-lg text-sm flex items-center gap-2 border"
          :class="activeTab===t.key
            ? 'bg-black/5 dark:bg-white/10 border-black/20 dark:border-white/20'
            : 'hover:bg-black/5 dark:hover:bg-white/10 border-transparent'">
          <span aria-hidden="true">{{ t.icon }}</span>
          <span>{{ t.label }}</span>
          <span v-if="t.badge!==undefined" class="ml-1 text-xs opacity-70">({{ t.badge }})</span>
        </button>
      </nav>
      <div class="p-4 min-h-[320px]">
        <component
          :is="panelComponent"
          :scan="activeScan"
          :items="activeTab==='findings' ? findings : activeTab==='history' ? history : undefined"
          :ticket-id="tid"
          :sid="sftpSid"
          :root-path="startForm.root_path"
          @select="onSelectScan"
          @remove="onRemoveScan"
        />
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
const cleanDomain = (v?: string) => {
  const s = decodeURIComponent(String(v || "").trim())
    .replace(/^https?:\/\//i, "")
    .replace(/\/+$/,"");
  const p = s.toLowerCase();
  if (!s || ["website url","website-url","http://website url","https://website url"].includes(p)) return "";
  return s;
};

import { ref, onMounted, watch, computed, onBeforeUnmount } from 'vue'
import { useRoute } from 'vue-router'
import { getTicket, startMalwareScan, getScan, getMalwareHistory, type Ticket, type Scan } from '@/api'
import SftpExplorerInline from '@/components/scan/SftpExplorerInline.vue'
import TabFindings from '@/components/scan/TabFindings.vue'
import TabRepairs from '@/components/scan/TabRepairs.vue'
import TabReports from '@/components/scan/TabReports.vue'
import TabLogs from '@/components/scan/TabLogs.vue'
import TabHistory from '@/components/scan/TabHistory.vue'
import { getMalwareFindings, createReport } from '@/api'
import { cancelMalwareScan } from '@/api'
import { deleteScan } from '@/api'
const canceling = ref(false)
const route = useRoute()
const tid = Number(route.params.id)

const ticket = ref<Ticket | null>(null)
const error = ref<string | null>(null)
const rootPath = ref<string>('/')

const startForm = ref({ root_path: '/', quick: false, overwrite_baseline: false })
const starting = ref(false)
const startError = ref<string | null>(null)
const sftpSid = ref<string>("")

const activeScan = ref<Scan | null>(null)
const history = ref<Scan[]>([])
const findings = ref<any[]>([]) 
let pollTimer: number|undefined
let pollFindingsTimer: number|undefined

type TabKey = 'findings'|'repairs'|'reports'|'logs'|'history'
const activeTab = ref<TabKey>('findings')
const tabs = computed(() => ([
  { key: 'findings', icon: 'üß≠', label: 'Findings', badge: findings.value.length },
  { key: 'repairs',  icon: 'üß∞', label: 'Repairs' },
  { key: 'reports',  icon: 'üìÑ', label: 'Reports' },
  { key: 'logs',     icon: 'üìú', label: 'Logs' },
  { key: 'history',  icon: 'üóÇÔ∏è', label: 'History', badge: history.value.length },
] as const))
const panelComponent = computed(() => {
  switch (activeTab.value) {
    case 'findings': return TabFindings
    case 'repairs':  return TabRepairs
    case 'reports':  return TabReports
    case 'logs':     return TabLogs
    case 'history':  return TabHistory
  }
})

onMounted(async () => {
  try {
    ticket.value = await getTicket(tid)
    rootPath.value = ticket.value?.access?.root_path || '/'
    startForm.value.root_path = rootPath.value
    history.value = await getMalwareHistory(tid).catch(() => [])
    const running = history.value.find(s => s.status === 'running' || s.status === 'queued')
    if (running) { activeScan.value = running; startPolling() }
  } catch (e:any) {
    error.value = e?.response?.data?.message || e?.message || 'Fehler beim Laden'
  }
})
async function onCancel() {
  if (!activeScan.value?.id) return;
  canceling.value = true;
  try {
    await cancelMalwareScan(activeScan.value.id);
  } finally {
    canceling.value = false;
  }
}

function onSftpConnected(sid: string) { sftpSid.value = sid }
watch(rootPath, p => { startForm.value.root_path = p || '/' }, { immediate:true })

async function onStart() {
  startError.value = null
  starting.value = true
  try {
    const sftp = {
      host: ticket.value?.access?.ftp_host || "",
      port: Number(ticket.value?.access?.ftp_port || 22),
      username: ticket.value?.access?.ftp_user || "",
      password: ticket.value?.access?.ftp_pass || "",
      root_path: startForm.value.root_path || "/",
    }
    if (!(sftp.host && sftp.username && sftp.password) && !sftpSid.value) {
      throw new Error("Bitte zuerst verbinden oder SFTP-Zugang hinterlegen.")
    }
    const body: any = {
      ticket_id: tid,
      root_path: sftp.root_path,
      quick: !!startForm.value.quick,
      overwrite_baseline: !!startForm.value.overwrite_baseline,
      sftp,
      tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "Europe/Berlin",
      customer: {
        domain: cleanDomain(ticket.value?.domain),
        name:   ticket.value?.name || "",
        email:  ticket.value?.email || "",
        cms:    ticket.value?.cms || "",
        hoster: ticket.value?.hoster || "",
        beschreibung: ticket.value?.beschreibung || ""
      }
    };
    if (sftpSid.value) body.sid = sftpSid.value;


    const s = await startMalwareScan(body)
    activeScan.value = s
    activeTab.value = "findings"
    startPolling()
  } catch (e:any) {
    startError.value = e?.response?.data?.message || e?.message || "Start fehlgeschlagen"
  } finally {
    starting.value = false
  }
}
async function onSelectScan(s:any) {
  try {
    // vollen Scan laden, falls history-Eintrag options nicht enth√§lt
    const full = s.options ? s : await getScan(String(s.id))
    activeScan.value = full

    // Root aus options.root_path > root > '/'
    const root = full?.options?.root_path || full?.root || '/'
    rootPath.value = root
    startForm.value.root_path = root

    // SFTP-Session aus options.sid √ºbernehmen
    if (full?.options?.sid) {
      sftpSid.value = full.options.sid
    }

    activeTab.value = 'findings'
    startPolling()
    await fetchFindingsOnce()
  } catch {}
}

async function onRemoveScan(s:any) {
  if (!confirm(`Scan ${s.id} l√∂schen?`)) return
  try {
    await deleteScan(String(s.id))
  } finally {
    history.value = await getMalwareHistory(tid).catch(() => [])
    if (activeScan.value?.id === s.id) {
      activeScan.value = null
      findings.value = []
    }
  }
}
function startPolling() {
  stopPolling();
  if (!activeScan.value?.id) return;

  // Status
    // Status
  pollTimer = window.setInterval(async () => {
    try {
      const s = await getScan(activeScan.value!.id);
      activeScan.value = s;

      const isDone = ['ok','issues','failed','canceled'].includes(s.status)
      if (isDone) {
        stopPolling();

        // Falls erfolgreich/teilweise (ok/issues): Report automatisch erzeugen
        if (['ok','issues'].includes(s.status)) {
          try {
            await createReport({
              scan_id: String(s.id),
              title: `Malware-Report ‚Ä¢ Ticket #${tid} ‚Ä¢ ${new Date().toLocaleString()}`,
              // wir geben die bisher geladenen Daten mit:
              data: { scan: s, findings: findings.value || [] }
            })
          } catch {}
        }

        // Reports-Liste frisch laden (falls dein Tab Reports eine Methode hat ‚Äì ggf. via Event)
        // Beispiel (einfach): history neu laden oder TabReports reacten lassen.
      }
    } catch {}
  }, 2000);


  // LIVE-Findings
  fetchFindingsOnce();
  pollFindingsTimer = window.setInterval(fetchFindingsOnce, 2000);
}

async function fetchFindingsOnce() {
  if (!activeScan.value?.id) return;
  try {
    findings.value = await getMalwareFindings(activeScan.value.id);
  } catch {}
}



function stopPolling() {
  if (pollTimer) clearInterval(pollTimer)
  if (pollFindingsTimer) clearInterval(pollFindingsTimer)
  pollTimer = pollFindingsTimer = undefined
}

watch(() => route.params.id, (v) => {
  const n = Number(v)
  if (n && n !== tid) { stopPolling() }
})
</script>


<style scoped>
.min-h-\[320px\]{min-height:320px}
</style>
