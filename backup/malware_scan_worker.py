# malware_scan_worker.py
import os, re, time, tempfile
import paramiko
import mysql.connector
from scan_patterns import MALWARE_PATTERNS

def update_progress(db, scan_id, checked, total, current_file, rot, orange, gruen):
    cursor = db.cursor()
    cursor.execute("""
        REPLACE INTO scan_progress (scan_id, checked_files, total_files, current_file, rot, orange, gruen, updated_at)
        VALUES (%s, %s, %s, %s, %s, %s, %s, NOW())
    """, (scan_id, checked, total, current_file, rot, orange, gruen))
    db.commit()
    cursor.close()

def insert_fund(db, scan_id, file, level, desc, line, snippet):
    cursor = db.cursor()
    cursor.execute("""
        INSERT INTO scan_results (scan_id, file, level, desc_text, line, snippet)
        VALUES (%s, %s, %s, %s, %s, %s)
    """, (scan_id, file, level, desc, line, snippet))
    db.commit()
    cursor.close()

def malware_scan_worker(scan_id, ftp_host, ftp_user, ftp_pass, db_config, patterns=MALWARE_PATTERNS):
    db = mysql.connector.connect(**db_config)
    try:
        # Jobstatus auf "running"
        cursor = db.cursor()
        cursor.execute("UPDATE scan_jobs SET status='running', started_at=NOW() WHERE id=%s", (scan_id,))
        db.commit()
        cursor.close()

        # SFTP Connect
        ssh = paramiko.SSHClient()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        ssh.connect(ftp_host, username=ftp_user, password=ftp_pass)
        sftp = ssh.open_sftp()

        # Rekursive Dateiliste (nur .php/.js/.html/.htaccess/.txt/.ini)
        def list_files_rec(sftp, path):
            files = []
            for entry in sftp.listdir_attr(path):
                fullpath = os.path.join(path, entry.filename)
                if entry.st_mode & 0o040000:  # directory
                    if entry.filename.startswith('.'): continue  # skip .git/.env
                    files += list_files_rec(sftp, fullpath)
                else:
                    if any(fullpath.endswith(x) for x in ('.php','.js','.html','.htaccess','.txt','.ini')):
                        files.append(fullpath)
            return files
        files = list_files_rec(sftp, '.')

        total = len(files)
        checked = 0
        rot = orange = gruen = 0

        for file in files:
            try:
                with sftp.open(file, 'r') as f:
                     content = f.read().decode('utf-8', errors='ignore')
            except Exception as e:
                checked += 1
                update_progress(db, scan_id, checked, total, file, rot, orange, gruen)
                continue

            found = False
            for pat in patterns:
                m = re.search(pat['regex'], content)
                if m:
                    line_nr = content[:m.start()].count('\n') + 1
                    snippet = content[max(0, m.start()-20):m.end()+40]
                    insert_fund(db, scan_id, file, pat['level'], pat['desc'], line_nr, snippet)
                    if pat['level'] == 'rot': rot += 1
                    elif pat['level'] == 'orange': orange += 1
                    else: pass  # KEIN gruen += 1 hier!
                    found = True
                    break
            if not found:
                gruen += 1  # <-- NUR wenn kein Pattern matcht!
            checked += 1
            update_progress(db, scan_id, checked, total, file, rot, orange, gruen)


        # Fertig-Status
        cursor = db.cursor()
        cursor.execute("UPDATE scan_jobs SET status='done', finished_at=NOW() WHERE id=%s", (scan_id,))
        db.commit()
        cursor.close()
        sftp.close()
        ssh.close()
    except Exception as e:
        cursor = db.cursor()
        cursor.execute("UPDATE scan_jobs SET status='error', error_message=%s WHERE id=%s", (str(e), scan_id))
        db.commit()
        cursor.close()
    finally:
        db.close()
