# app/modules/wp_repair/modules/malware/yara_manager.py
from __future__ import annotations

import os
import subprocess
from dataclasses import dataclass
from typing import Dict, List, Optional, Tuple

from flask import current_app


@dataclass(frozen=True)
class YaraInfo:
    enabled: bool
    ruleset_path: str
    ruleset_name: str
    ruleset_version: str  # git commit hash or "unknown"
    yara_version: str
    rule_files: int
    compiled_files: int
    skipped_files: List[str]
    error: Optional[str] = None


_YARA_CACHE = {
    "compiled": None,      # yara.Rules
    "version": None,       # git head
    "ruleset_path": None,  # rules dir
}


def _log_warn(msg: str, *args):
    try:
        current_app.logger.warning(msg, *args)
    except Exception:
        pass


def _env(name: str, default: str) -> str:
    v = os.getenv(name)
    return v if v is not None and v != "" else default


def _git_head(repo_dir: str) -> str:
    try:
        out = subprocess.check_output(
            ["git", "-C", repo_dir, "rev-parse", "HEAD"],
            stderr=subprocess.DEVNULL,
            text=True,
            timeout=3,
        ).strip()
        return out or "unknown"
    except Exception:
        return "unknown"


def _collect_rule_files(rules_dir: str) -> List[str]:
    out: List[str] = []
    for root, _, files in os.walk(rules_dir):
        for fn in files:
            low = fn.lower()
            if low.endswith((".yar", ".yara")):
                out.append(os.path.join(root, fn))
    out.sort()
    return out


def get_yara(*, enabled: bool = True) -> Tuple[Optional[object], YaraInfo]:
    """
    Loads and compiles YARA rules (cached).
    Returns (rules_or_None, info).
    """
    env_enabled = _env("SF_YARA_ENABLED", "1") == "1"
    if not enabled or not env_enabled:
        info = YaraInfo(
            enabled=False,
            ruleset_path="",
            ruleset_name="signature-base",
            ruleset_version="disabled",
            yara_version="unknown",
            rule_files=0,
            compiled_files=0,
            skipped_files=[],
            error="disabled",
        )
        return None, info

    base_dir = _env("SF_YARA_BASE_DIR", "/var/www/sitefixer/rules/yara/signature-base")
    rules_dir = _env("SF_YARA_RULES_DIR", os.path.join(base_dir, "yara"))

    ruleset_version = _git_head(base_dir)

    if not os.path.isdir(rules_dir):
        info = YaraInfo(
            enabled=True,
            ruleset_path=rules_dir,
            ruleset_name="signature-base",
            ruleset_version=ruleset_version,
            yara_version="unknown",
            rule_files=0,
            compiled_files=0,
            skipped_files=[],
            error=f"rules_dir not found: {rules_dir}",
        )
        return None, info

    # Cache hit?
    if (
        _YARA_CACHE["compiled"] is not None
        and _YARA_CACHE["version"] == ruleset_version
        and _YARA_CACHE["ruleset_path"] == rules_dir
    ):
        info = YaraInfo(
            enabled=True,
            ruleset_path=rules_dir,
            ruleset_name="signature-base",
            ruleset_version=ruleset_version,
            yara_version="cached",
            rule_files=-1,
            compiled_files=-1,
            skipped_files=[],
            error=None,
        )
        return _YARA_CACHE["compiled"], info

    try:
        import yara  # type: ignore
        yara_version = getattr(yara, "__version__", "unknown")
    except Exception as e:
        info = YaraInfo(
            enabled=True,
            ruleset_path=rules_dir,
            ruleset_name="signature-base",
            ruleset_version=ruleset_version,
            yara_version="unknown",
            rule_files=0,
            compiled_files=0,
            skipped_files=[],
            error=f"yara-python not installed/import failed: {e}",
        )
        return None, info

    rule_files = _collect_rule_files(rules_dir)
    if not rule_files:
        info = YaraInfo(
            enabled=True,
            ruleset_path=rules_dir,
            ruleset_name="signature-base",
            ruleset_version=ruleset_version,
            yara_version=yara_version,
            rule_files=0,
            compiled_files=0,
            skipped_files=[],
            error="no .yar/.yara files found",
        )
        return None, info

    # Many community rules use these as externals.
    externals = {
        "filepath": "",
        "filename": "",
        "extension": "",
        "filetype": "",
        "mime": "",
        "owner": "",
    }

    # Try compile all, else fallback to per-file skipping.
    try:
        filepaths = {f"r{i}": p for i, p in enumerate(rule_files)}
        rules = yara.compile(filepaths=filepaths, externals=externals)

        _YARA_CACHE["compiled"] = rules
        _YARA_CACHE["version"] = ruleset_version
        _YARA_CACHE["ruleset_path"] = rules_dir

        info = YaraInfo(
            enabled=True,
            ruleset_path=rules_dir,
            ruleset_name="signature-base",
            ruleset_version=ruleset_version,
            yara_version=yara_version,
            rule_files=len(rule_files),
            compiled_files=len(rule_files),
            skipped_files=[],
            error=None,
        )
        return rules, info

    except Exception as e:
        _log_warn("YARA compile(all) failed, falling back to per-file skip: %s", e)

        skipped: List[str] = []
        ok_files: Dict[str, str] = {}

        for i, p in enumerate(rule_files):
            try:
                _ = yara.compile(filepath=p, externals=externals)
                ok_files[f"r{i}"] = p
            except Exception:
                skipped.append(p)

        if not ok_files:
            info = YaraInfo(
                enabled=True,
                ruleset_path=rules_dir,
                ruleset_name="signature-base",
                ruleset_version=ruleset_version,
                yara_version=yara_version,
                rule_files=len(rule_files),
                compiled_files=0,
                skipped_files=skipped[:200],
                error=str(e),
            )
            return None, info

        try:
            rules = yara.compile(filepaths=ok_files, externals=externals)

            _YARA_CACHE["compiled"] = rules
            _YARA_CACHE["version"] = ruleset_version
            _YARA_CACHE["ruleset_path"] = rules_dir

            info = YaraInfo(
                enabled=True,
                ruleset_path=rules_dir,
                ruleset_name="signature-base",
                ruleset_version=ruleset_version,
                yara_version=yara_version,
                rule_files=len(rule_files),
                compiled_files=len(ok_files),
                skipped_files=skipped[:200],
                error=None,
            )
            return rules, info

        except Exception as e2:
            info = YaraInfo(
                enabled=True,
                ruleset_path=rules_dir,
                ruleset_name="signature-base",
                ruleset_version=ruleset_version,
                yara_version=yara_version,
                rule_files=len(rule_files),
                compiled_files=0,
                skipped_files=skipped[:200],
                error=str(e2),
            )
            return None, info
