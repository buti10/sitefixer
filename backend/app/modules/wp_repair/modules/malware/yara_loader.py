# app/modules/wp_repair/modules/malware/yara_loader.py
from __future__ import annotations

from typing import Dict, Any, List
from flask import current_app


def yara_match(
    rules,
    *,
    data: bytes,
    filepath: str,
) -> List[Dict[str, Any]]:
    if not rules:
        return []

    externals = {
        "filepath": filepath or "",
        "filename": (filepath.rsplit("/", 1)[-1] if filepath else ""),
        "extension": (("." + filepath.rsplit(".", 1)[-1]) if filepath and "." in filepath else ""),
        "filetype": "",
        "mime": "",
        "owner": "",
    }

    try:
        matches = rules.match(data=data, externals=externals) or []
    except Exception as e:
        # Important: don't crash scan; also don't rely on app context existing.
        try:
            current_app.logger.warning("YARA match failed for %s: %s", filepath, e)
        except Exception:
            pass
        return []

    out: List[Dict[str, Any]] = []
    for m in matches:
        out.append(
            {
                "rule": getattr(m, "rule", None),
                "namespace": getattr(m, "namespace", None),
                "tags": list(getattr(m, "tags", []) or []),
                "meta": dict(getattr(m, "meta", {}) or {}),
            }
        )
    return out
