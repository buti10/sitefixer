CREATE TABLE IF NOT EXISTS scans (
  id INT AUTO_INCREMENT PRIMARY KEY,
  ticket_id INT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  started_at DATETIME NULL,
  finished_at DATETIME NULL,
  status ENUM('queued','running','ok','issues','failed','canceled') DEFAULT 'queued',
  progress INT DEFAULT 0,
  summary JSON NULL,              -- {counts:{total,scanned,clean,suspicious,malicious,errors}}
  options JSON NULL,              -- {quick, overwrite_baseline, root_path, sid}
  notes TEXT NULL
);

CREATE TABLE IF NOT EXISTS findings (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  scan_id INT NOT NULL,
  path VARCHAR(1024) NOT NULL,
  severity ENUM('low','medium','high') NOT NULL,
  kind VARCHAR(64) NOT NULL,      -- z.B. dangerous_functions, obfuscation, yara_match, read_error
  detail JSON NULL,               -- {sha256, info|rules|error}
  detected_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_scan (scan_id),
  FOREIGN KEY (scan_id) REFERENCES scans(id) ON DELETE CASCADE
);

-- optional: SFTP Sessions falls noch nicht vorhanden
CREATE TABLE IF NOT EXISTS sftp_sessions (
  id INT AUTO_INCREMENT PRIMARY KEY,
  sid VARCHAR(64) UNIQUE NOT NULL,
  host VARCHAR(255) NOT NULL,
  port INT DEFAULT 22,
  username VARCHAR(255) NOT NULL,
  password TEXT NULL,
  private_key TEXT NULL,
  root_path VARCHAR(1024) DEFAULT '/'
);
