<style>
    .card-stats {
      border-radius: 18px;
      padding: 18px 0 10px 0;
      box-shadow: 0 2px 12px 0 #eaeaea66;
      min-width: 120px;
    }
    .span {
        font-size: 80px;
    }
    </style>
    
<div class="container py-4">
    <div class="dashboard-card mx-auto" style="max-width:1850px;">
      <div class="mb-3 d-flex justify-content-between align-items-center">
        <h2><i class="bi bi-bug"></i> Malware-Scan <span class="text-muted">#{{ scan_id }}</span></h2>
        <span id="scanStatusBadge" class="badge fs-5 px-3 py-2 bg-{{ 'danger' if scan.rot > 0 else 'warning' if scan.orange > 0 else 'success' }}">
            {{ 'KRITISCH' if scan.rot > 0 else 'WARNUNG' if scan.orange > 0 else 'SAUBER' }}
          </span>
      </div>
      <!-- Statistiken -->
      <div class="row text-center mb-4 gap-2">
        <div class="col card-stats bg-info text-white">
            <div class="fw-bold small"><i class="bi bi-files"></i> Gesamt</div>
            <div class="display-6"><span id="stat_total">{{ scan.total_files }}</span></div>
          </div>
          <div class="col card-stats bg-primary text-white">
            <div class="fw-bold small"><i class="bi bi-search"></i> Gescannt</div>
            <div class="display-6"><span id="stat_checked">{{ scan.checked_files }}</span></div>
          </div>
          <div class="col card-stats bg-danger text-white">
            <div class="fw-bold small"><i class="bi bi-exclamation-triangle"></i> Kritisch</div>
            <div class="display-6"><span id="stat_rot">{{ scan.rot }}</span></div>
          </div>
          <div class="col card-stats bg-warning text-white">
            <div class="fw-bold small"><i class="bi bi-exclamation-circle"></i> Warnung</div>
            <div class="display-6"><span id="stat_orange">{{ scan.orange }}</span></div>
          </div>
          <div class="col card-stats bg-success text-white">
            <div class="fw-bold small"><i class="bi bi-shield-check"></i> Clean</div>
            <div class="display-6"><span id="stat_gruen">{{ scan.gruen }}</span></div>
          </div>
          
      </div>
      
      <!-- Progressbar -->
      <div class="mb-2 fw-bold">
        Fortschritt: <div id="progressText">0/0</div> Dateien gescannt
      </div>
      <div class="progress mb-4" style="height: 22px;">
        <div id="progressBar" class="progress-bar progress-bar-striped bg-info" role="progressbar" style="width: 0%">
          0%
        </div>
      </div>
      <div class="mb-2">
        Aktuelle Datei: <code id="currentFile">-</code>
      </div>
      
      <div id="scanHint" class="alert alert-info" style="display:none">
        Der Scan wird vorbereitetâ€¦<br>
        Bitte habe etwas Geduld â€“ bei groÃŸen Projekten kann das initiale Einlesen aller Dateien paar Minuten dauern!
      </div>
      
      <div class="mb-3 text-muted small">
        Gestartet: {{ scan.started_at or "-" }} |
        Dauer: {{ scan.duration or "-" }}s |
        Status: <span id="scanStatusText">{{ 'Abgeschlossen' if scan.checked_files == scan.total_files else 'Scan lÃ¤uft...' }}</span>
      </div>
      <!-- Fundtabelle -->
      <div class="table-responsive mt-4">
        <table class="table table-striped table-hover align-middle" id="fundTable">
          <thead class="table-dark">
            <tr>
              <th>Dateiname</th>
              <th>Status</th>
              <th>Zeile</th>
              <th>Pattern</th>
              <th>Snippet</th>
            </tr>
          </thead>
          <tbody id="fundList">
            <!-- Wird per AJAX befÃ¼llt, z. B.: -->
            <!---
            <tr>
              <td>wp-content/plugins/foo.php</td>
              <td><span class="badge bg-danger">Kritisch</span></td>
              <td>42</td>
              <td>eval(...)</td>
              <td><button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#snippetModal" data-snippet="....">Anzeigen</button></td>
            </tr>
            --->
          </tbody>
        </table>
        <div id="noFindings" class="text-center text-success my-3" style="display:none;">
          ðŸŽ‰ Keine Bedrohungen oder Warnungen gefunden!
        </div>
      </div>
      <!-- Aktionen -->
      <div class="mt-4 d-flex gap-2">
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> ZurÃ¼ck</a>
        <a id="btnExportPDF" href="/scan/export/pdf/{{ scan_id }}" class="btn btn-outline-primary"><i class="bi bi-file-earmark-pdf"></i> PDF</a>
        <a id="btnExportJSON" href="/scan/export/json/{{ scan_id }}" class="btn btn-outline-success"><i class="bi bi-file-earmark-code"></i> JSON</a>
      </div>
    </div>
  </div>
  
    <script>
let scanId = {{ scan_id }};
let intervalId = null;

function refreshScanStatus() {
  $.getJSON('/scan/progress/' + scanId, function(scan) {
    // Karten/Statistiken
    $('#stat_total').text(scan.total_files);
    $('#stat_checked').text(scan.checked_files);
    $('#stat_rot').text(scan.rot);
    $('#stat_orange').text(scan.orange);
    $('#stat_gruen').text(scan.gruen);

    // Fortschritt
    $('#progressText').text(scan.checked_files + "/" + scan.total_files);
    let percent = scan.total_files ? Math.round(scan.checked_files / scan.total_files * 100) : 0;
    $('#progressBar').css('width', percent + '%').text(percent + '%');

    // Aktuelle Datei
    $('#currentFile').text(scan.current_file || '-');

    // Status-Badge und Text
    let badge = 'success', statusText = 'SAUBER';
    if (scan.rot > 0) { badge = 'danger'; statusText = 'KRITISCH'; }
    else if (scan.orange > 0) { badge = 'warning'; statusText = 'WARNUNG'; }
    $('#scanStatusBadge')
      .removeClass('bg-success bg-danger bg-warning')
      .addClass('bg-' + badge)
      .text(statusText);

    $('#scanStatusText').text(scan.checked_files == scan.total_files ? 'Abgeschlossen' : 'Scan lÃ¤uft...');

    // Ergebnisse laden
    if(scan.checked_files > 0){
      $.getJSON('/scan/findings/' + scanId, function(results) {
        let html = '';
        if(results.length === 0){
          $('#noFindings').show();
          $('#fundList').empty();
        }else{
          $('#noFindings').hide();
          results.forEach(r => {
            let status = r.level === 'rot'
              ? '<span class="badge bg-danger">Kritisch</span>'
              : (r.level === 'orange'
                ? '<span class="badge bg-warning text-dark">Warnung</span>'
                : '<span class="badge bg-success">Clean</span>');
            html += `<tr>
              <td>${r.file}</td>
              <td>${status}</td>
              <td>${r.line}</td>
              <td>${r.pattern}</td>
              <td><span class="d-inline-block text-truncate" style="max-width:160px" title="${r.snippet}">${r.snippet}</span></td>
            </tr>`;
          });
          $('#fundList').html(html);
        }
      });
    }

    // Wenn Scan fertig -> stoppen
     // Nur aufhÃ¶ren, wenn status wirklich fertig ist!
     if(scan.status === "done" || scan.status === "error"){
      clearInterval(intervalId);
      $('#scanStatusText').text(scan.status === "done" ? 'Abgeschlossen' : 'Fehler');
    }
  });
}

$(function() {
  intervalId = setInterval(refreshScanStatus, 2000); // alle 2 Sekunden
  refreshScanStatus(); // Initial
});
</script>
    