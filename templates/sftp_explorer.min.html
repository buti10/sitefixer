{% extends "base.html" %} {% block content %}<div class="container py-4" style=max-width:1320px><div class="row g-4 align-items-stretch"><div class="col-md-5 d-flex"><div class="card shadow-lg rounded-4 p-4 mb-5 w-100 h-100 d-flex flex-column justify-content-between" style=min-height:540px;background:#fff;border:none><h2 class=mb-4><i class="bi bi-hdd-network"></i> SFTP-Explorer für <b>{{ kunde.name }}</b></h2><form id=sftpForm autocomplete=off class="row g-2"><div class=col-md-4><input class=form-control name=ftp_host value="{{ zugang.ftp_host or '' }}" placeholder="FTP Host" required></div><div class=col-md-3><input class=form-control name=ftp_user value="{{ zugang.ftp_user or '' }}" placeholder="FTP User" required></div><div class=col-md-3><input class=form-control name=ftp_pass value="{{ zugang.ftp_pass or '' }}" placeholder="FTP Passwort" required></div><div class="col-md-2 d-grid"><button class="btn btn-primary" type=submit><i class="bi bi-link-45deg"></i> Verbinden</button></div></form><div id=sftpError class="alert alert-danger mt-3" style=display:none></div><div id=ordnerBaumBox class="mt-4 flex-grow-1 d-flex flex-column" style=display:none><h5 class=mb-3><i class="bi bi-folder2-open"></i> Ordnerstruktur</h5><div id=ordnerBaum class=ersatz-tree-ui style="max-height:340px;min-height:270px;overflow:auto;border-radius:12px;border:1px solid #eee;padding:1rem;background:#fafbfc"></div><button class="btn btn-success mt-4 w-100" id=scanStartenBtn disabled><i class="bi bi-bug"></i> Scan für gewählte Ordner starten</button></div></div></div><div class="col-md-2 d-flex flex-column align-items-center justify-content-center gap-4" style=min-width:150px><button class="btn btn-outline-primary w-100 mb-2" id=btnReplace disabled><i class="bi bi-arrow-repeat"></i> Ersetzen</button><button class="btn btn-outline-danger w-100 mb-2" id=btnDeleteSftp disabled><i class="bi bi-trash"></i> SFTP-Ordner löschen</button><button class="btn btn-outline-danger w-100" id=btnDeleteErsatz disabled><i class="bi bi-trash"></i> Ersatz-Ordner löschen</button></div><div class="col-md-5 d-flex"><div class="card shadow-lg rounded-4 p-4 mb-5 w-100 h-100 d-flex flex-column justify-content-between" style=min-height:540px;background:#f8f9fb;border:none><h2 class=mb-4><i class="bi bi-arrow-repeat"></i> Ersatz-Ordner/Dateien</h2><div class="d-flex mb-3 gap-2"><input type=file id=uploadInput style=display:none><button class="btn btn-outline-primary" id=btnUpload><i class="bi bi-upload"></i> Upload</button><button class="btn btn-outline-secondary" id=btnNewFolder><i class="bi bi-folder-plus"></i> Neuer Ordner</button></div><div id=ersatzBaumBox class="flex-grow-1 d-flex flex-column"><div id=ersatzBaum class=ersatz-tree-ui style="max-height:340px;min-height:270px;overflow:auto;border-radius:12px;border:1px solid #eee;padding:1rem;background:#fff"></div></div></div></div></div></div><script src=https://code.jquery.com/jquery-3.6.0.min.js></script><link href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css rel=stylesheet><script>let sftpCreds={};function treeItemHTML(e){let t=e.is_dir?'<i class="bi bi-folder2 text-warning"></i>':'<i class="bi bi-file-earmark"></i>',r=e.is_dir?`<input type="checkbox" class="me-2" data-path="${e.path}">`:"",n=e.is_dir?`<span class="toggle-children" style="cursor:pointer;" data-path="${e.path}">[+]</span>`:"";return`<div class="tree-item" data-dir="${e.is_dir}" style="margin-left:0.5rem;">\n    ${r}${t} <span class="item-name">${e.name}</span> ${n}\n    <div class="children" style="margin-left:1.2rem; display:none"></div>\n  </div>`}$("#sftpForm").on("submit",(function(e){e.preventDefault(),$("#sftpError").hide(),$("#ordnerBaum").empty(),$("#scanStartenBtn").prop("disabled",!0),$("#ordnerBaumBox").hide(),sftpCreds={ftp_host:$('[name="ftp_host"]').val(),ftp_user:$('[name="ftp_user"]').val(),ftp_pass:$('[name="ftp_pass"]').val()},$.post("/api/sftp-listdir",{...sftpCreds,path:"."},(function(e){if(e.success){$("#ordnerBaumBox").show();let t="";e.items.forEach((e=>{t+=treeItemHTML(e)})),$("#ordnerBaum").html(t)}else $("#sftpError").text(e.error||"Unbekannter Fehler!").show()}))})),$("#ordnerBaum").on("click",".toggle-children",(function(){let e=$(this).closest(".tree-item").find(">.children"),t=$(this).data("path");if(e.children().length>0)return e.slideToggle(160),void $(this).text(e.is(":visible")?"[-]":"[+]");$(this).html('<span class="spinner-border spinner-border-sm text-primary"></span>'),$.post("/api/sftp-listdir",{...sftpCreds,path:t},(function(r){if(r.success){let t="";r.items.forEach((e=>{t+=treeItemHTML(e)})),e.html(t).slideDown(150)}else e.html(`<div class="text-danger small">Fehler: ${r.error}</div>`);$('.toggle-children[data-path="'+t+'"]').text("[-]")}))})),$("#ordnerBaum").on("change","input[type=checkbox]",(function(){$(this).closest(".tree-item").toggleClass("selected",this.checked)})),$("#ersatzBaum").on("change",".ersatz-checkbox",(function(){$(this).closest("li").toggleClass("selected",this.checked)})),$("#ordnerBaum").on("change","input[type=checkbox]",(function(){let e=$("#ordnerBaum input[type=checkbox]:checked").length;$("#scanStartenBtn").prop("disabled",0===e),$("#btnReplace, #btnDeleteSftp").prop("disabled",0===e)}));let ersatzAktuellerPfad="";function ersatzTreeHTML(e,t){let r=document.createElement("ul");return e.forEach((e=>{let t=document.createElement("li");e.is_dir?t.innerHTML=`\n              <input type="checkbox" class="me-2 ersatz-checkbox" data-path="${e.path}">\n              <i class="bi bi-folder2 text-warning"></i> \n              <span class="ersatz-dir" style="cursor:pointer;" data-path="${e.path}">${e.name}</span>\n              <button class="btn btn-link btn-sm ersatz-new-subfolder" data-path="${e.path}" title="Unterordner anlegen">\n                  <i class="bi bi-folder-plus"></i>\n              </button>\n              <div class="ersatz-children" style="margin-left:1.1rem; display:none"></div>\n            `:t.innerHTML=`<i class="bi bi-file-earmark"></i> ${e.name}`,r.appendChild(t)})),r}function renderErsatzTree(e=""){ersatzAktuellerPfad=e,$.get("/ersatz-tree",{path:e},(function(t){if(t.success){let r=ersatzTreeHTML(t.items,e);e?$(`#ersatzBaum .ersatz-dir[data-path="${e}"]`).parent().find(".ersatz-children").html(r).slideDown(120):$("#ersatzBaum").empty().append(r)}else alert("Fehler beim Laden: "+t.error)}))}renderErsatzTree(),$("#ersatzBaum").on("click",".ersatz-dir",(function(e){e.stopPropagation();let t=$(this).parent().find(">.ersatz-children");t.children().length?t.slideToggle(100):renderErsatzTree($(this).data("path"))})),$("#ersatzBaum").on("click",".ersatz-new-subfolder",(function(e){e.stopPropagation();let t=$(this).data("path"),r=prompt("Neuer Ordnername:");r&&$.post("/ersatz-new-folder",{path:t,folder_name:r},(function(e){e.success?renderErsatzTree(t):alert("Fehler: "+e.error)}))})),$("#btnUpload").on("click",(function(){$("#uploadInput").click()})),$("#uploadInput").on("change",(function(){let e=this.files[0];if(!e)return;let t=new FormData;t.append("file",e),t.append("path",ersatzAktuellerPfad),$.ajax({url:"/ersatz-upload",type:"POST",data:t,processData:!1,contentType:!1,success:function(e){e.success?renderErsatzTree(ersatzAktuellerPfad):alert("Fehler: "+e.error)}})})),$("#btnNewFolder").on("click",(function(){let e=prompt("Neuer Ordnername:");e&&$.post("/ersatz-new-folder",{path:"",folder_name:e},(function(e){e.success?renderErsatzTree(""):alert("Fehler: "+e.error)}))})),$("#ersatzBaum").on("change",".ersatz-checkbox",(function(){let e=$("#ersatzBaum .ersatz-checkbox:checked").length;$("#btnDeleteErsatz").prop("disabled",0===e),$("#btnReplace").prop("disabled",!($("#ordnerBaum input[type=checkbox]:checked").length&&e))})),$("#btnReplace").on("click",(function(){let e=$("#ordnerBaum input[type=checkbox]:checked").map((function(){return $(this).data("path")})).get(),t=$("#ersatzBaum .ersatz-checkbox:checked").map((function(){return $(this).data("path")})).get();e.length&&t.length?alert("Ersetzen: "+JSON.stringify({sftpOrdner:e,ersatzOrdner:t})):alert("Wähle SFTP-Ordner und Ersatz-Ordner!")})),$("#btnDeleteSftp").on("click",(function(){let e=$("#ordnerBaum input[type=checkbox]:checked").map((function(){return $(this).data("path")})).get();e.length?alert("SFTP löschen: "+JSON.stringify({sftpOrdner:e})):alert("Wähle SFTP-Ordner!")})),$("#btnDeleteErsatz").on("click",(function(){let e=$("#ersatzBaum .ersatz-checkbox:checked").map((function(){return $(this).data("path")})).get();e.length?alert("Ersatz-Ordner löschen: "+JSON.stringify({ersatzOrdner:e})):alert("Wähle Ersatz-Ordner!")}))</script><link href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css rel=stylesheet><style>:root{--main-blue:#3666fa;--main-green:#38b679;--soft-bg:#f7fafd;--card-bg:#fff;--border-radius:2.2rem;--shadow:0 4px 24px 0 rgba(41, 70, 130, 0.12);--tree-selected:#e7f0ff;--tree-hover:#f1f7ff;--tree-icon:#b3bce6;--danger:#e13e4b;--muted:#848ea2;--font-main:'Inter','Segoe UI',Arial,sans-serif}body,html{font-family:var(--font-main);background:linear-gradient(120deg,var(--soft-bg) 70%,#eaf3ff 100%);color:#263049;min-height:100vh}.card{border-radius:var(--border-radius)!important;background:var(--card-bg)!important;box-shadow:var(--shadow);border:none!important;padding:2.3rem 2.1rem 1.6rem 2.1rem}.card h2,.card h5{font-weight:700;letter-spacing:-1px;margin-bottom:1.4rem}@media (max-width:1000px){.card{padding:1.1rem .6rem 1rem .6rem}}#ersatzBaum,#ordnerBaum{background:#fafdff;border-radius:1.2rem;border:1px solid #f0f2f8;padding:1.3rem;min-height:130px;font-size:1.03em;max-height:355px;overflow-y:auto}#ersatzBaum li,.tree-item{border-radius:.7rem;padding:.07em .2em;transition:background .13s}#ersatzBaum li.selected,.tree-item.selected{background:var(--tree-selected)!important;color:var(--main-blue)!important}#ersatzBaum li:hover,.tree-item:hover{background:var(--tree-hover)}#ersatzBaum .ersatz-dir,.tree-item .item-name{font-weight:500;font-size:1.09em;cursor:pointer;padding:.04em .3em;border-radius:.5em}.ersatz-toggle,.toggle-children{color:var(--muted);margin-left:.2em;user-select:none;font-size:1em;cursor:pointer}input[type=checkbox].me-2{transform:scale(1.18);margin-right:.38em!important}.bi-folder,.bi-folder2{color:var(--main-blue)!important;filter:drop-shadow(0 1px 2px #eaf2ff)}.bi-file-earmark{color:#adb4c2}.bi{vertical-align:-.1em;font-size:1.15em}.btn,.btn-outline-danger,.btn-outline-primary,.btn-outline-secondary,.btn-primary,.btn-success{border-radius:1.3rem!important;font-weight:600;letter-spacing:.01em;box-shadow:0 2px 10px rgba(60,110,200,.1);border:none;padding:.62em 1.23em;transition:background .16s,color .14s,box-shadow .14s}.btn-primary{background:linear-gradient(95deg,var(--main-blue) 82%,#589cff 100%)!important;color:#fff!important}.btn-primary:hover,.btn-success:hover{background:linear-gradient(95deg,#274cb3 85%,#3666fa 100%)!important}.btn-success{background:linear-gradient(95deg,var(--main-green) 80%,#44d19e 100%)!important;color:#fff!important}.btn-danger,.btn-outline-danger{color:var(--danger)!important;background:0 0!important;border:1.5px solid #fad2d6!important}.btn-danger:hover,.btn-outline-danger:hover{background:#fff2f3!important}.btn-outline-primary{color:var(--main-blue)!important;background:0 0!important;border:1.5px solid #bdd6fc!important}.btn-outline-primary:hover{background:#eaf3ff!important}.btn-outline-secondary{color:var(--muted)!important;background:0 0!important;border:1.5px solid #e2e8f8!important}.btn-outline-secondary:hover{background:#f7fafd!important}.mid-toolbar{display:flex;flex-direction:column;gap:1.1rem;align-items:center;margin:0 1.1rem}@media (max-width:900px){.mid-toolbar{flex-direction:row;margin:.6rem 0;justify-content:flex-start}}#btnUpload{position:relative}#btnUpload.dragover{background:#eaf3ff!important;border:2px dashed var(--main-blue)!important}.ersatz-breadcrumb{color:#bbb;font-size:.97em;margin-bottom:.9em}.ersatz-breadcrumb .active{color:var(--main-blue);font-weight:500}.empty-state{color:#b0b8cb;text-align:center;padding:1.5em 0;font-size:1.18em;letter-spacing:.04em}#ersatzBaum::-webkit-scrollbar,#ordnerBaum::-webkit-scrollbar{width:11px;background:#f1f5fa;border-radius:8px}#ersatzBaum::-webkit-scrollbar-thumb,#ordnerBaum::-webkit-scrollbar-thumb{background:#d2d8ea;border-radius:8px}.dark-mode #ersatzBaum::-webkit-scrollbar-thumb,.dark-mode #ordnerBaum::-webkit-scrollbar-thumb{background:#23273a}.dark-mode,.dark-mode body,.dark-mode html{background:linear-gradient(125deg,#1b1e25 50%,#23263a 100%)!important;color:#e3eaf3!important}.dark-mode .card{background:#1a1c22!important;box-shadow:0 6px 24px rgba(32,42,80,.26)}.dark-mode #ersatzBaum,.dark-mode #ordnerBaum{background:#22242d!important;border-color:#262b39!important;color:#e3eaf3!important}.dark-mode #ersatzBaum li.selected,.dark-mode .tree-item.selected{background:#313c57!important;color:#5ebaff!important}.dark-mode #ersatzBaum li:hover,.dark-mode .tree-item:hover{background:#232a39!important}.dark-mode #ersatzBaum .ersatz-dir,.dark-mode .tree-item .item-name{color:#e3eaf3!important}.dark-mode .btn,.dark-mode .btn-primary,.dark-mode .btn-success{color:#e3eaf3!important;background:#273350!important}.dark-mode .btn-primary{background:linear-gradient(95deg,#3c67ec 70%,#2965ff 100%)!important}.dark-mode .btn-success{background:linear-gradient(95deg,#3fbb8f 70%,#259769 100%)!important}.dark-mode .btn-outline-primary{color:#8ec7ff!important;border-color:#3b5275!important;background:0 0!important}.dark-mode .btn-outline-secondary{color:#7c879b!important;border-color:#323d54!important}.dark-mode .btn-danger,.dark-mode .btn-outline-danger{color:#f399a0!important;background:0 0!important;border-color:#63354d!important}.dark-mode .btn-danger:hover,.dark-mode .btn-outline-danger:hover{background:#2d222b!important}.dark-mode .bi-folder,.dark-mode .bi-folder2{color:#63a5ff!important;filter:none}.dark-mode .bi-file-earmark{color:#8d99ac}.dark-mode .empty-state{color:#444e68}</style>{% endblock %}